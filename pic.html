<html>
<head>
<title>Random imgur image</title>
<style type="text/css">
img { max-width: 100%; height: auto; }
</style>
<script language="javascript" type="text/javascript">
var foundimgs = [];
var historyimgs = [];
var imgObject = new Image();
var numTries = 1;
var img_loading = false;

imgObject.onload = function() {
	if (this.width == 161 && this.height == 81) {
		this.src = "http://i.imgur.com/" + randomString(5) + ".jpg";
		numTries++;
		return;
	}
	foundimgs.push([numTries, this.src]);
	numTries = 1;
	img_loading = false;
	if (historyimgs.length == 0) {
		img_next();
		// img_next() will cause loading of another img
		return;
	}
	document.getElementById("cache").innerHTML = foundimgs.length;
	// if less than 25 imgs in cache, search for more
	if (foundimgs.length < 25)
		getImages();
};

imgObject.onerror = function() { img_loading = false; getImages(); };

function randomString(string_length) {
	var chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghiklmnopqrstuvwxyz";
	var output = "";
	var index;

	for (var i = 0; i < string_length; i++) {
		var index = Math.floor(Math.random() * chars.length);
		output += chars.substring(index, index + 1);
	}

	return output;
}

function getImages() {
	if (img_loading) return;
	img_loading = true;
	imgObject.src = "http://i.imgur.com/" + randomString(5) + ".jpg";
}

function img_next() {
	// load next image
	if (foundimgs.length == 0) return;
	var img_data = foundimgs.shift();
	historyimgs.push(img_data);
	img_show(img_data);
	document.getElementById("cache").innerHTML = foundimgs.length;
	if (foundimgs.length < 25)
		getImages();
}

function img_prev() {
	// go one image back
	if (historyimgs.length <= 1) return; // Can't go back
	foundimgs.unshift(historyimgs.pop());
	document.getElementById("cache").innerHTML = foundimgs.length;
	img_show(historyimgs[historyimgs.length - 1]);
}

function img_show(data) {
	var html = "It took "+data[0]+" to get this picture. ";
	if (historyimgs.length > 1)
		html += "<a href=\"javascript:img_prev();\">Prev img</a> ";
	html += "<a href=\"javascript:img_next();\">Next img</a><br/><br/>";
	html += "<a href=\"" + data[1] + "\">" + data[1] + "<br/><img src=\"" + data[1] + "\" /></a>";
	document.getElementById('a').innerHTML = html;
}

document.onkeydown = function(e) {
	e = e || window.event;
	if (e.keyCode == 37) {
		img_prev();
	} else if (e.keyCode == 39) {
		img_next();
	}
};

</script>
<body onLoad="getImages();">
<h1>Random Imgur image</h1>
<div>Cache status: <span id="cache">0</span>.</div>
<div id="a">Please wait...</div>
</body>
</html>
